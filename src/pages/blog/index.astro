---
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import FormattedDate from '../../components/FormattedDate.astro';
import Header from '../../components/Header.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../consts';

const posts = (await getCollection('blog')).sort(
	(a, b) => a.data.pubDate && b.data.pubDate ? b.data.pubDate?.valueOf() - a.data.pubDate?.valueOf() : 0,
);
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
		<style lang="scss">
			main { width: 960px; margin: 0 auto; flex: 1;
				.blog-toolbar {
					display: flex;
					justify-content: space-between;
					align-items: center;
					margin-bottom: 1rem;
					
					@media (max-width: 720px) {
						flex-direction: column;
						gap: 1rem;
						align-items: stretch;
					}

					.search-wrapper {
						position: relative;
						flex: 1;
						max-width: 400px;
						
						svg {
							position: absolute;
							left: 12px;
							top: 50%;
							transform: translateY(-50%);
							color: #888;
							width: 18px;
							height: 18px;
						}
						
						input {
							width: 100%;
							padding: 10px 10px 10px 40px;
							border: 1px solid #eaeaea;
							border-radius: 8px;
							font-size: 1rem;
							outline: none;
							transition: border-color 0.2s;
							
							&:focus {
								border-color: rgb(var(--accent));
							}
						}
					}

					.view-options {
						display: flex;
						gap: 0.5rem;
						
						button {
							background: #fff;
							border: 1px solid #ddd;
							border-radius: 8px;
							padding: 8px;
							cursor: pointer;
							color: #555;
							display: flex;
							align-items: center;
							justify-content: center;
							transition: all 0.2s;
							box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
							
							&:hover {
								background: #f9f9f9;
								border-color: #ccc;
								color: #333;
								box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
							}
							
							&.active {
								background: #98b6c9;
								color: white;
								
								svg {
									stroke: white !important;
									color: white !important;
								}
							}
							
							svg {
								width: 20px;
								height: 20px;
								transition: stroke 0.2s;
							}
						}
					}
				}

				ul { display: grid; grid-template-columns: 1fr; gap: 2rem;
					list-style-type: none; margin: 0; padding: 0;
					
					&.view-grid {
						grid-template-columns: 1fr 1fr;
						
						li {
							flex-direction: column;
							.thumbnail {
								width: 100%; height: 200px; flex: 0 0 200px;
								max-height: 200px;
							}
						}
					}

					&.view-list {
						gap: 1rem;
						li {
							align-items: center;
							.thumbnail {
								width: 120px; height: 90px; flex: 0 0 120px;
							}
							.blog-content {
								padding: 10px 20px;
								justify-content: center;
								.description, .repo { display: none; }
								.title { font-size: 1.2rem; }
							}
						}
					}

					li { width: 100%; display: flex; border: 1px solid #eaeaea; border-radius: 12px;
    				overflow: hidden; transition: all .3s cubic-bezier(.25, .8, .25, 1);
						background: #fff;
						
						@media (max-width: 720px) {
							flex-direction: column;
						}
						.thumbnail { width: 200px; height: 100%; flex: 0 0 200px;
							@media (max-width: 720px) {
								width: 100%; max-height: 200px;
							}
						}
						.article-wrapper { display: flex; width: 100%; text-decoration: none; position: relative;
							@media (max-width: 720px) {
								display: block;
							}
							// Inherit flex direction from li
							flex-direction: inherit;

							.main-link {
								position: absolute;
								top: 0;
								left: 0;
								width: 100%;
								height: 100%;
								z-index: 1;
							}
						}
						img { width: 100%; height: 100%; object-fit: cover; transition: transform .5s ease; border-radius: 0;}
						.blog-content { display: flex; flex-direction: column; padding: 20px;
							flex: 1;
							background: linear-gradient(135deg, #fff, #fdfdfd); gap: 10px;
							.title { margin: 0; color: rgb(var(--black)); line-height: 1.2; }
							.description { margin: 0; color: rgb(var(--gray)); line-height: 1.5; }
							.date { margin: 0; color: rgb(var(--gray)); line-height: 1; }
							.repo { margin: 0; color: rgb(var(--gray)); line-height: 1; position: relative; z-index: 2; }
						}
					}				
				}
			}
			ul li * {
				text-decoration: none;
				transition: 0.2s ease;
			}
			.title {
				margin: 0;
				color: rgb(var(--black));
				line-height: 1;
			}
			.date {
				margin: 0;
				color: rgb(var(--gray));
			}
			ul li:hover h4,
			ul li:hover .date {
				color: rgb(var(--accent));
			}
			ul li:hover {
				box-shadow: var(--box-shadow);
			}
			@media (max-width: 720px) {
				main ul {
					grid-template-columns: 1fr !important;
					gap: 1rem;
				}
				ul li {
					width: 100%;
					text-align: center;
				}
			}
		</style>
	</head>
	<body>
		<Header />
		<main>
			<section>
				<div class="blog-toolbar">
					<div class="search-wrapper">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
						<input type="text" id="blog-search" placeholder="Search articles..." />
					</div>
					<div class="view-options">
						<button class="view-btn active" data-view="large" title="Large View">
							<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="12" x2="21" y2="12"></line></svg>
						</button>
						<button class="view-btn" data-view="grid" title="Grid View">
							<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
						</button>
						<button class="view-btn" data-view="list" title="List View">
							<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
						</button>
					</div>
				</div>
				<ul id="blog-posts-list" class="view-large">
					{
						posts.map((post) => (
							<li>
								<div class="article-wrapper">
									<a href={`/blog/${post.id}/`} class="main-link"><span class="sr-only">{post.data.title}</span></a>
									{post.data.heroImage && (
										<div class="thumbnail">
											<Image width={720} height={360} src={post.data.heroImage} alt="" />
										</div>
									)}
									<div class="blog-content">
										<h4 class="title">{post.data.title}</h4>
										<p class="description">{post.data.description}</p>
										{post.data.repo && <div class="repo">
											<a href={post.data.repo} target="_blank">View on GitHub</a>
										</div>}
										<p class="date">
											<FormattedDate date={post.data.pubDate!} />
										</p>
									</div>
								</div>
							</li>
						))
					}
				</ul>
			</section>
		</main>
		<script>
			// Search functionality
			const searchInput = document.getElementById('blog-search') as HTMLInputElement;
			const list = document.getElementById('blog-posts-list');
			const posts = list?.querySelectorAll('li');

			searchInput?.addEventListener('input', (e) => {
				const searchTerm = (e.target as HTMLInputElement).value.toLowerCase();
				
				posts?.forEach(post => {
					const title = post.querySelector('.title')?.textContent?.toLowerCase() || '';
					const description = post.querySelector('.description')?.textContent?.toLowerCase() || '';
					
					if (title.includes(searchTerm) || description.includes(searchTerm)) {
						post.style.display = '';
					} else {
						post.style.display = 'none';
					}
				});
			});

			// View switching functionality
			const viewBtns = document.querySelectorAll('.view-btn');
			
			viewBtns.forEach(btn => {
				btn.addEventListener('click', () => {
					// Remove active class from all buttons
					viewBtns.forEach(b => b.classList.remove('active'));
					// Add active class to clicked button
					btn.classList.add('active');
					
					// Get view mode
					const mode = btn.getAttribute('data-view');
					
					// Update list class
					if (list && mode) {
						list.className = `view-${mode}`;
						// Save preference
						localStorage.setItem('blog-view-mode', mode);
					}
				});
			});

			// Load preference
			const savedMode = localStorage.getItem('blog-view-mode');
			if (savedMode) {
				const btn = document.querySelector(`.view-btn[data-view="${savedMode}"]`);
				if (btn) {
					(btn as HTMLElement).click();
				}
			}
		</script>
		<Footer />
	</body>
</html>
